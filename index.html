<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplex-noise/2.4.0/simplex-noise.min.js"></script>
  </head>
  <body>
    <button id="gifButton" style="position: fixed; top: 10px; right: 10px; z-index: 10000;">Record GIF</button>
  <!-- We'll use CCapture.js for better GIF recording -->
  <script src="https://cdn.jsdelivr.net/npm/ccapture.js@1.1.0/build/CCapture.all.min.js"></script>
<canvas id="perlinCanvas" width="800" height="800" style="z-index: -2000;position: absolute;top:0%;left: 0;width: -moz-available;width: -webkit-fill-available; height: 140%;"></canvas>
  <script src="https://cdn.jsdelivr.net/npm/gif.js.optimized@1.0.1/dist/gif.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/simplex-noise/2.4.0/simplex-noise.min.js"></script>

<script>
  const canvas = document.getElementById('perlinCanvas');
  const ctx = canvas.getContext('2d');
  const simplex = new SimplexNoise();
  const scale = 0.002;
  const zoffSpeed = 0.006;
  let zoff = 0;

  let gif = null;
  let isRecording = false;
  let recordedFrames = [];
  const framesToRecord = 30; // 1 second at 30fps

  document.getElementById('gifButton').addEventListener('click', function() {
    if (!isRecording) {
      startRecording();
    } else {
      stopRecording();
    }
  });

  function startRecording() {
    recordedFrames = [];
    isRecording = true;
    document.getElementById('gifButton').textContent = 'Recording...';
    console.log('Recording started');
  }

  function stopRecording() {
    isRecording = false;
    document.getElementById('gifButton').textContent = 'Processing...';

    // Create GIF
    gif = new GIF({
      worker: false, // Don't use web worker
      quality: 10,
      width: canvas.width,
      height: canvas.height
    });

    // Add frames
    recordedFrames.forEach(frame => {
      gif.addFrame(frame, {delay: 33}); // ~30fps
    });

    gif.on('finished', function(blob) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'perlin-noise.gif';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        document.getElementById('gifButton').textContent = 'Record GIF';
      }, 100);
    });

    gif.render();
  }

  function drawNoise() {
    const imageData = ctx.createImageData(canvas.width, canvas.height);
    const data = imageData.data;

    let i = 0;
    for (let y = 0; y < canvas.height; y++) {
      for (let x = 0; x < canvas.width; x++) {
        const nx = x * scale;
        const ny = y * scale;
        const value = simplex.noise2D(nx + zoff, ny + zoff);
        const normalizedValue = (value + 1) / 2;
        const threshold = 0.5;

        if (normalizedValue > threshold) {
          const intensity = (normalizedValue - threshold) / (1 - threshold);
          const r = 20 + Math.floor(235 * intensity * 0.8);
          const g = 20 + Math.floor(100 * intensity);
          const b = 20 + Math.floor(200 * intensity);

          data[i++] = r;
          data[i++] = g;
          data[i++] = b;
        } else {
          data[i++] = 20;
          data[i++] = 20;
          data[i++] = 20;
        }
        data[i++] = 255;
      }
    }

    ctx.putImageData(imageData, 0, 0);

    // Capture frame if recording
    if (isRecording && recordedFrames.length < framesToRecord) {
      const frameCanvas = document.createElement('canvas');
      frameCanvas.width = canvas.width;
      frameCanvas.height = canvas.height;
      const frameCtx = frameCanvas.getContext('2d');
      frameCtx.drawImage(canvas, 0, 0);
      recordedFrames.push(frameCanvas);

      if (recordedFrames.length >= framesToRecord) {
        stopRecording();
      }
    }

    zoff += zoffSpeed;
    requestAnimationFrame(drawNoise);
  }

  drawNoise();
</script>

  </body>
</html>
